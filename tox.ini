[tox]
min_version = 4.0
env_list =
    format
    validate
    pytest

[coverage:paths]
source =
    src
    */site-packages

[coverage:run]
omit =
    */tethys/cli.py

[coverage:report]
fail_under = 100

[flake8]
# see https://black.readthedocs.io/en/stable/guides/using_black_with_other_tools.html#id2
max-line-length = 88
extend-ignore = E203,E501

[pycodestyle]
ignore = E203,E501
max_line_length = 88

[pydocstyle]
add_ignore = D104,D105,D107,D401

[pytest]
minversion = 6.0
addopts =
    -ra
    -q
    --cov=tethys
    --cov-config=tox.ini
testpaths =
    tests

[testenv:format]
description = autoformat the source files
deps =
    -e .
    black
    isort
    pyupgrade
    pydocstringformatter
commands =
    black src
    isort src tests
    python -c "from pathlib import Path; from pyupgrade._main import main; main([str(s) for s in list(Path('.').glob('src/**/*.py')) + list(Path('.').glob('tests/**/*.py'))])"
    pydocstringformatter src tests

[testenv:docs]
description = generate docs
deps =
    -e .
    sphinx
    myst-parser
    rst-to-myst
    sphinx-rtd-dark-mode
    sphinx-rtd-theme==0.5.2 # see https://github.com/MrDogeBro/sphinx_rtd_dark_mode/issues/28
setenv =
    SPHINX_APIDOC_OPTIONS = members,show-inheritance # see https://github.com/sphinx-doc/sphinx/issues/8664
commands =
    sphinx-apidoc -f -o docs/source src/tethys # using src/tethys prevents 'src' entry in TOC
    sphinx-build -b html docs/source docs/build/html

[testenv:pytest]
description = run tests with pytest
deps =
    -e .
    pytest
    pytest-cov
commands =
    pytest --cov-report=html:coverage/py311

[testenv:validate]
description = validate the source files
deps =
    -e .
    bandit[toml]
    flake8
    flake8-bugbear
    mypy
    types-click
    types-requests
    pycodestyle
    pydocstyle
    validate-pyproject
commands =
    bandit -r src
    flake8 src tests
    mypy src
    pycodestyle src
    pydocstyle src
    validate-pyproject pyproject.toml
